name: Deploy to jpdata

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DEPLOY_HOST: 185.200.65.233
  DEPLOY_USER: root

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.JPDATA_SSH_KEY }}" > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy
          ssh-keyscan -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy
        run: |
          ssh -i ~/.ssh/id_deploy ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} \
            "bash /opt/jimeng-gateway/scripts/deploy.sh"
